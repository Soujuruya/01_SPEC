# Ядро системы геооповещений
## Описание

Разработано ядро системы геооповещений на языке Go.

Система предназначена для обработки геоданных, поступающих от мобильных клиентов, и определения попадания пользователей в опасные зоны (инциденты).

## Описание запуска проекта

### 1. Подготовка переменных окружения

В /config находится файл env.example.

Скопируй его и создай файл .env:

````bash
cp env.example .env
````
### 2. Настройка туннеля для вебхуков (Tuna / ngrok)

Для приёма webhook-запросов от внешнего портала требуется публичный адрес.
Для этого используется туннель (Tuna или ngrok).

Пример с Tuna

* Получи токен авторизации Tuna

* Запусти туннель:
```
tuna http 9090
```
В выводе команды будет указан Forwarding адрес, например:
```
https://skmmum-2a05-541-100-ec--1.ru.tuna.am
```
### 3. Обнови .env файл:

```
WEBHOOK_URL=твой forwarding url сюда
TUNA_AUTH_TOKEN=твой токен сюда
```
* WEBHOOK_URL — адрес, на который сервис будет отправлять webhook-уведомления
* TUNA_AUTH_TOKEN — токен для авторизации туннеля

### 4. Запуск сервиса
После настройки окружения и туннеля запусти сервис командой из Makefile:
```
make up
```

### 5. Остановка сервиса
```
make stop
```
Останавливает:

* webhook stub
* все Docker-контейнеры

### 6. Полная очистка окружения

```
make clean
```
Дополнительно удаляет:

* Docker volumes

* неиспользуемые контейнеры

## Миграции базы данных

#### Локальная среда и миграции

Для локальной разработки и работы с миграциями используется файл config/local.env.

Для управления миграциями используется встроенная утилита (cmd/migrate).

#### Применить миграции
```
make migrate-up
```
Применяет все доступные миграции из папки migrations.

#### Откатить миграции
```
make migrate-down
```
Полностью откатывает все миграции.

#### Проверить версию миграций
```
make migrate-version
```
Показывает:

* текущую версию схемы БД

* состояние dirty

#### Примечания

Миграции используют тот же конфигурационный файл, что и сервис

Перед запуском миграций PostgreSQL должен быть доступен

Команды предназначены для локальной разработки

## Примеры запросов (Postman)

Я подготовил коллекцию Postman для тестирования API.  
Вы можете импортировать её в Postman:

[Скачать коллекцию](./cmd/api/docs/postman_collection.json)

### Примеры некоторых запросов:

* Создание инцидента

**POST** `/api/v1/incidents`

Тело запроса:

```json
{
"title": "Минное поле",
"lat": 50,
"lng": 60,
"radius": 45
}
```

Ответ:

```json
{
    "status": "ok",
    "data": {
        "id": "c96e6b28-29a9-4da0-ae4b-4479ede6ad98",
        "title": "Минное поле",
        "lat": 50,
        "lng": 60,
        "radius": 45,
        "is_active": true,
        "created_at": "2026-01-14T02:31:55Z"
    }
}
```

* Получить список инцидентов

**GET** `/api/v1/incidents?offset=0&limit=15`


```json
{
  "status": "ok",
  "data": {
    "incidents": [
      {
        "id": "c96e6b28-29a9-4da0-ae4b-4479ede6ad98",
        "title": "Минное поле",
        "lat": 50,
        "lng": 60,
        "radius": 45,
        "is_active": true,
        "created_at": "2026-01-14T02:31:55Z"
      },
      {
        "id": "4677dc32-6334-48c6-9050-aa14ce882792",
        "title": "Злые псы",
        "lat": 20,
        "lng": 35,
        "radius": 100,
        "is_active": false,
        "created_at": "2026-01-14T01:11:42Z"
      },
      {
        "id": "b92d45b5-5aad-493c-b520-fbfd34ccb67f",
        "title": "Пожар",
        "lat": 25,
        "lng": 30,
        "radius": 200,
        "is_active": true,
        "created_at": "2026-01-14T01:11:09Z"
      },
      {
        "id": "10d7022e-e979-4211-a9c5-1f3aa2e0cac2",
        "title": "Атака титанов",
        "lat": 75,
        "lng": 180,
        "radius": 1500,
        "is_active": true,
        "created_at": "2026-01-14T01:10:38Z"
      },
      {
        "id": "96973684-48ec-4890-b931-cf40e3d6f344",
        "title": "Инопланетяне",
        "lat": 80,
        "lng": 60,
        "radius": 1500,
        "is_active": true,
        "created_at": "2026-01-14T01:10:21Z"
      }
    ],
    "limit": 15,
    "offset": 0,
    "total": 5
  }
}
```

* Проверить локацию пользователя

**POST** `/api/v1/location/check`

Тело запроса:

```json
{
  "user_id": "55555515-5555-5255-5555-555555555552",
  "lat": 80,
  "lng": 60
}
```
Тело ответа:
```json
{
    "status": "ok",
    "data": {
        "id": "6a85d608-3971-429c-9251-e4db2d6a3d94",
        "user_id": "55555515-5555-5255-5555-555555555552",
        "lat": 80,
        "lng": 60,
        "timestamp": "2026-01-14T02:34:51.521808599Z",
        "is_check": true,
        "incident_ids": [
            "96973684-48ec-4890-b931-cf40e3d6f344"
        ]
    }
}
```

* Статистика

**GET** `/api/v1/incidents/stats`
```json
{
    "status": "ok",
    "data": {
        "user_count": 1
    }
}
```

## Документация Swagger

Для удобной работы с API доступна интерактивная документация Swagger:

URL Swagger UI: http://127.0.0.1:8080/swagger/index.html

Она позволяет просматривать все эндпоинты, их параметры, тело запросов и ответы.

Также можно тестировать запросы прямо из браузера.

Убедитесь, что сервис запущен локально (make up) перед открытием Swagger UI.
## Назначение системы

Мобильное приложение периодически отправляет текущие координаты пользователя.

Сервис:

1. Синхронно:

* принимает координаты пользователя;

* определяет, попадает ли пользователь в одну или несколько опасных зон;

* возвращает список соответствующих инцидентов.

2. Асинхронно:

* при обнаружении опасных зон отправляет уведомление (webhook);

* уведомление направляется во внешний новостной портал.

## Архитектурные особенности

* HTTP API реализован на net/http

* Чёткое разделение слоёв:

* handlers (HTTP)

* usecase (бизнес-логика)

* repository (PostgreSQL / Redis)

* Асинхронная обработка вебхуков через очередь (Redis)

* Отдельный worker для отправки webhook-уведомлений

* Swagger-документация для всех публичных API

* Поддержка graceful shutdown

## Основные сценарии работы

1. Пользователь перемещается

2. Мобильное приложение отправляет координаты

3. Сервис проверяет попадание в радиус инцидента

4. Возвращает данные клиенту

5. При наличии опасности:

* событие ставится в очередь

* webhook отправляется асинхронно

